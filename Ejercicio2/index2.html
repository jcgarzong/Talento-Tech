<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Interfaz de Alquiler</title>
  <script src="https://cdn.ethers.org/lib/ethers-5.2.umd.min.js" type="application/javascript"></script>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@400;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 font-ubuntu">
  <div class="container mx-auto p-6">
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Interfaz de Alquiler</h1>

    <button id="connectButton" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">
      Conectar Billetera
    </button>

    <p id="walletAddress" class="mt-4 text-gray-600"></p>

    <div class="mt-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Crear Alquiler</h2>
      <form id="createForm">
        <div class="mb-4">
          <label for="inquilino" class="block text-gray-700 text-sm font-bold mb-2">Dirección del Inquilino:</label>
          <input type="text" id="inquilino" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="0x...">
        </div>
        <div class="mb-4">
          <label for="montoMensual" class="block text-gray-700 text-sm font-bold mb-2">Monto Mensual (Wei):</label>
          <input type="number" id="montoMensual" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="1000000000000000000">
        </div>
        <div class="mb-4">
          <label for="duracionMeses" class="block text-gray-700 text-sm font-bold mb-2">Duración (Meses):</label>
          <input type="number" id="duracionMeses" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="12">
        </div>
        <div class="mb-4">
          <label for="deposito" class="block text-gray-700 text-sm font-bold mb-2">Depósito (Wei):</label>
          <input type="number" id="deposito" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="1000000000000000000">
        </div>
        <button type="submit" class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
          Crear Alquiler
        </button>
      </form>
    </div>

    <div class="mt-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Pagar Alquiler</h2>
      <form id="pagarForm">
        <div class="mb-4">
          <label for="idAlquilerPagar" class="block text-gray-700 text-sm font-bold mb-2">ID del Alquiler:</label>
          <input type="number" id="idAlquilerPagar" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="1">
        </div>
        <button type="submit" class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
          Pagar Alquiler
        </button>
      </form>
    </div>

    <div class="mt-8">
      <h2 class="text-2xl font-bold text-gray-800 mb-4">Finalizar Alquiler</h2>
      <form id="finalizarForm">
        <div class="mb-4">
          <label for="idAlquilerFinalizar" class="block text-gray-700 text-sm font-bold mb-2">ID del Alquiler:</label>
          <input type="number" id="idAlquilerFinalizar" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="1">
        </div>
        <button type="submit" class="bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
          Finalizar Alquiler
        </button>
      </form>
    </div>

  </div>

  <script>
    const contractAddress = "0x7a0729fA21ff5998dd141a33aB0a19FC6d66f06C";
    const contractABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_inquilino",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "_montoMensual",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_duracionMeses",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "_deposito",
				"type": "uint256"
			}
		],
		"name": "crearAlquiler",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_idAlquiler",
				"type": "uint256"
			}
		],
		"name": "finalizarAlquiler",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "idAlquiler",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "propietario",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "address",
				"name": "inquilino",
				"type": "address"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "montoMensual",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "duracionMeses",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "fechaInicio",
				"type": "uint256"
			},
			{
				"indexed": false,
				"internalType": "uint256",
				"name": "deposito",
				"type": "uint256"
			}
		],
		"name": "NuevoAlquiler",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "_idAlquiler",
				"type": "uint256"
			}
		],
		"name": "pagarAlquiler",
		"outputs": [],
		"stateMutability": "payable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "alquileres",
		"outputs": [
			{
				"internalType": "address",
				"name": "propietario",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "inquilino",
				"type": "address"
			},
			{
				"internalType": "uint256",
				"name": "montoMensual",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "duracionMeses",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "fechaInicio",
				"type": "uint256"
			},
			{
				"internalType": "uint256",
				"name": "deposito",
				"type": "uint256"
			},
			{
				"internalType": "bool",
				"name": "activo",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "proximoIdAlquiler",
		"outputs": [
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];

    let provider;
    let signer;
    let contract;

    const connectButton = document.getElementById('connectButton');
    const walletAddress = document.getElementById('walletAddress');
    const createForm = document.getElementById('createForm');
    const pagarForm = document.getElementById('pagarForm');
    const finalizarForm = document.getElementById('finalizarForm');

    connectButton.addEventListener('click', async () => {
      if (window.ethereum) {
        try {
          await window.ethereum.request({ method: 'eth_requestAccounts' });
          provider = new ethers.providers.Web3Provider(window.ethereum);
          signer = provider.getSigner();
          contract = new ethers.Contract(contractAddress, contractABI, signer);

          const address = await signer.getAddress();
          walletAddress.textContent = `Dirección de la billetera: ${address}`;
        } catch (error) {
          console.error(error);
          alert("Error al conectar a la billetera.");
        }
      } else {
        alert("Por favor, instala MetaMask.");
      }
    });

    createForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const inquilino = document.getElementById('inquilino').value;
      const montoMensual = document.getElementById('montoMensual').value;
      const duracionMeses = document.getElementById('duracionMeses').value;
      const deposito = document.getElementById('deposito').value;

      try {
        const tx = await contract.crearAlquiler(inquilino, montoMensual, duracionMeses, deposito);
        await tx.wait();
        alert("Alquiler creado exitosamente.");
      } catch (error) {
        console.error(error);
        alert("Error al crear el alquiler.");
      }
    });

    pagarForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const idAlquilerPagar = document.getElementById('idAlquilerPagar').value;

      try {
        const tx = await contract.pagarAlquiler(idAlquilerPagar, { value: ethers.utils.parseEther("1") }); // Ajusta el valor según el monto del alquiler
        await tx.wait();
        alert("Alquiler pagado exitosamente.");
      } catch (error) {
        console.error(error);
        alert("Error al pagar el alquiler.");
      }
    });

    finalizarForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const idAlquilerFinalizar = document.getElementById('idAlquilerFinalizar').value;

      try {
        const tx = await contract.finalizarAlquiler(idAlquilerFinalizar);
        await tx.wait();
        alert("Alquiler finalizado exitosamente.");
      } catch (error) {
        console.error(error);
        alert("Error al finalizar el alquiler.");
      }
    });
  </script>
</body>
</html>